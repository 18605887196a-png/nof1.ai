/**
* open-nof1.ai - AI åŠ å¯†è´§å¸è‡ªåŠ¨äº¤æ˜“ç³»ç»Ÿ
* Copyright (C) 2025 195440
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <https://www.gnu.org/licenses/>.
*/




import { Agent } from "@voltagent/core";
import * as tradingTools from "../tools/trading";
import { createLogger } from "../utils/loggerUtils";
import { createOpenAIClientWithRotation } from "../utils/apiKeyManager";




const logger = createLogger({
name: "analysis-agents",
level: (process.env.LOG_LEVEL as any) || "info",
});




/**
* åˆ›å»ºæŠ€æœ¯åˆ†æAgent
* ä¸“æ³¨äºæŠ€æœ¯æŒ‡æ ‡åˆ†æ
* @param marketDataContext å¸‚åœºæ•°æ®ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰
*/
export async function createTechnicalAnalystAgent(marketDataContext?: any) {
const openai = await createOpenAIClientWithRotation();




// æ„å»ºåŒ…å«å¸‚åœºæ•°æ®çš„æŒ‡ä»¤
let instructions = `ä½ æ˜¯æŠ€æœ¯åˆ†æä¸“å®¶ï¼Œä¸“æ³¨äºåŠ å¯†è´§å¸æŠ€æœ¯æŒ‡æ ‡åˆ†æã€‚




ä½ çš„èŒè´£ï¼š
- åŸºäºæŠ€æœ¯æŒ‡æ ‡åˆ†æå¸‚åœºçŠ¶æ€
- è¯†åˆ«æ½œåœ¨çš„äº¤æ˜“æœºä¼šå’Œé£é™©
- æä¾›ä¸“ä¸šçš„æŠ€æœ¯åˆ†æè§è§£








è¯·åŸºäºä½ çš„ä¸“ä¸šåˆ¤æ–­ç»™å‡ºåˆ†æç»“è®ºå’Œå»ºè®®ï¼ŒåŒ…æ‹¬ï¼š
- æŠ€æœ¯é¢è¯„åˆ†ï¼ˆ1-10åˆ†ï¼Œ7åˆ†ä»¥ä¸Šä¸ºå¼ºåŠ¿ï¼‰
- ç½®ä¿¡åº¦è¯„ä¼°ï¼ˆé«˜/ä¸­/ä½ï¼‰
- å…³é”®æ”¯æ’‘ä½å’Œé˜»åŠ›ä½
- åŠ¨é‡æŒ‡æ ‡çŠ¶æ€
- äº¤æ˜“å»ºè®®ï¼ˆä¹°å…¥/å–å‡º/è§‚æœ›ï¼‰




è¯·åŸºäºä½ çš„ä¸“ä¸šç»éªŒç»™å‡ºå®¢è§‚çš„æŠ€æœ¯åˆ†æç»“è®ºã€‚`;




// å¦‚æœæœ‰å¸‚åœºæ•°æ®ä¸Šä¸‹æ–‡ï¼Œæ·»åŠ åˆ°æŒ‡ä»¤ä¸­
if (marketDataContext) {
  instructions += `\n\nå½“å‰å¸‚åœºæ•°æ®ä¸Šä¸‹æ–‡ï¼š\n${JSON.stringify(marketDataContext, null, 2)}`;
}




const agent = new Agent({
  name: "æŠ€æœ¯åˆ†æAgent",
  instructions,
  model: openai.chat(process.env.AI_MODEL_NAME || "deepseek/deepseek-v3.2-exp"),
  tools: [
    tradingTools.getMarketPriceTool,
    tradingTools.getTechnicalIndicatorsTool,
    tradingTools.getFundingRateTool,
    tradingTools.getAccountBalanceTool,
    tradingTools.getPositionsTool,
  ],
  logger: logger.child({ agent: "æŠ€æœ¯åˆ†æAgent" }),
});




return agent;
}




/**
* åˆ›å»ºè¶‹åŠ¿åˆ†æAgent
* ä¸“æ³¨äºå¤šæ—¶é—´æ¡†æ¶è¶‹åŠ¿åˆ†æ
* @param marketDataContext å¸‚åœºæ•°æ®ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰
*/
export async function createTrendAnalystAgent(marketDataContext?: any) {
const openai = await createOpenAIClientWithRotation();




// æ„å»ºåŒ…å«å¸‚åœºæ•°æ®çš„æŒ‡ä»¤
let instructions = `ä½ æ˜¯è¶‹åŠ¿åˆ†æä¸“å®¶ï¼Œä¸“æ³¨äºå¸‚åœºè¶‹åŠ¿è¯†åˆ«å’Œè¶‹åŠ¿çº¿åˆ†æã€‚








ä½ çš„èŒè´£ï¼š
- åˆ†æå¤šæ—¶é—´æ¡†æ¶çš„å¸‚åœºè¶‹åŠ¿
- è¯†åˆ«è¶‹åŠ¿çš„å¼ºåº¦å’ŒæŒç»­æ€§
- è¯„ä¼°å¸‚åœºçš„ä¸»è¦æ–¹å‘
- ç»˜åˆ¶æ”¯æ’‘çº¿å’Œé˜»åŠ›çº¿
- è¯†åˆ«ä»·æ ¼é€šé“å’Œçªç ´ç‚¹
- æä¾›åŸºäºè¶‹åŠ¿çº¿çš„äº¤æ˜“å»ºè®®




ä½ å¯ä»¥ä½¿ç”¨çš„å·¥å…·ï¼š
- getMarketPriceTool
- getTechnicalIndicatorsTool
- getFundingRateTool
- getOrderBookTool
- analyzeOrderBookDepthTool
- analyzeFundingRateTrendTool
- scientificTrendlineAnalysisTool
- getAccountBalanceTool
- getPositionsTool




è¯·åŸºäºä½ çš„ä¸“ä¸šåˆ¤æ–­ç»™å‡ºè¶‹åŠ¿åˆ†æç»“è®ºï¼ŒåŒ…æ‹¬ï¼š
- è¶‹åŠ¿æ–¹å‘ï¼ˆä¸Šæ¶¨/ä¸‹è·Œ/éœ‡è¡ï¼‰
- å¼ºåº¦è¯„åˆ†ï¼ˆ1-10åˆ†ï¼Œ7åˆ†ä»¥ä¸Šä¸ºå¼ºè¶‹åŠ¿ï¼‰
- ç½®ä¿¡åº¦è¯„ä¼°ï¼ˆé«˜/ä¸­/ä½ï¼‰
- å…³é”®è½¬æŠ˜ç‚¹å’Œæ”¯æ’‘é˜»åŠ›ä½
- è¶‹åŠ¿æŒç»­æ€§è¯„ä¼°
- çªç ´ä¿¡å·å’Œäº¤æ˜“å»ºè®®




è¯·åŸºäºä½ çš„ä¸“ä¸šç»éªŒç»™å‡ºå®¢è§‚çš„è¶‹åŠ¿åˆ†æç»“è®ºã€‚`;




// å¦‚æœæœ‰å¸‚åœºæ•°æ®ä¸Šä¸‹æ–‡ï¼Œæ·»åŠ åˆ°æŒ‡ä»¤ä¸­
if (marketDataContext) {
  instructions += `\n\nå½“å‰å¸‚åœºæ•°æ®ä¸Šä¸‹æ–‡ï¼š\n${JSON.stringify(marketDataContext, null, 2)}`;
}




const agent = new Agent({
  name: "è¶‹åŠ¿åˆ†æAgent",
  instructions,
  model: openai.chat(process.env.AI_MODEL_NAME || "deepseek/deepseek-v3.2-exp"),
  tools: [
    tradingTools.getMarketPriceTool,
    tradingTools.getTechnicalIndicatorsTool,
    tradingTools.getFundingRateTool,
    tradingTools.getOrderBookTool,
    tradingTools.analyzeFundingRateTrendTool,
    tradingTools.analyzeOrderBookDepthTool,
    tradingTools.scientificTrendlineAnalysisTool,
    tradingTools.getAccountBalanceTool,
    tradingTools.getPositionsTool,
  ],
  logger: logger.child({ agent: "è¶‹åŠ¿åˆ†æAgent" }),
});




return agent;
}




/**
* åˆ›å»ºé£é™©è¯„ä¼°Agent
* ä¸“æ³¨äºå¸‚åœºé£é™©è¯„ä¼°
* @param marketDataContext å¸‚åœºæ•°æ®ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰
*/
export async function createRiskAssessorAgent(marketDataContext?: any) {
const openai = await createOpenAIClientWithRotation();




// æ„å»ºåŒ…å«å¸‚åœºæ•°æ®çš„æŒ‡ä»¤
let instructions = `ä½ æ˜¯é£é™©è¯„ä¼°ä¸“å®¶ï¼Œä¸“æ³¨äºå¸‚åœºé£é™©è¯†åˆ«å’Œè¯„ä¼°ã€‚




ä½ çš„èŒè´£ï¼š
- è¯„ä¼°å½“å‰å¸‚åœºé£é™©æ°´å¹³
- è¯†åˆ«æ½œåœ¨çš„é£é™©å› ç´ 
- æä¾›é£é™©ç®¡ç†å»ºè®®




ä½ å¯ä»¥ä½¿ç”¨çš„å·¥å…·ï¼š
- getMarketPriceTool
- getTechnicalIndicatorsTool
- getFundingRateTool
- getOrderBookTool
- analyzeOrderBookDepthTool
- analyzeFundingRateTrendTool
- getAccountBalanceTool
- getPositionsTool




è¯·åŸºäºä½ çš„ä¸“ä¸šåˆ¤æ–­ç»™å‡ºé£é™©è¯„ä¼°ç»“è®ºï¼ŒåŒ…æ‹¬ï¼š
- é£é™©ç­‰çº§ï¼ˆä½/ä¸­/é«˜/æé«˜ï¼‰
- é£é™©è¯„åˆ†ï¼ˆ1-10åˆ†ï¼Œ7åˆ†ä»¥ä¸Šä¸ºé«˜é£é™©ï¼‰
- ç½®ä¿¡åº¦è¯„ä¼°ï¼ˆé«˜/ä¸­/ä½ï¼‰
- ä¸»è¦é£é™©å› ç´ å’Œæ½œåœ¨å½±å“
- é£é™©ç®¡ç†å»ºè®®ï¼ˆå…·ä½“æªæ–½ï¼‰








è¯·åŸºäºä½ çš„ä¸“ä¸šç»éªŒç»™å‡ºå®¢è§‚çš„é£é™©è¯„ä¼°ç»“è®ºï¼Œç»¼åˆè€ƒè™‘ï¼š
- å¸‚åœºæ³¢åŠ¨æ€§å’ŒæµåŠ¨æ€§çŠ¶å†µ
- æŒä»“é£é™©å’Œé›†ä¸­åº¦
- æ•´ä½“é£é™©ç¯å¢ƒ
- å¸‚åœºæƒ…ç»ªå’Œå¤–éƒ¨å› ç´ 




ä½œä¸ºé£é™©è¯„ä¼°ä¸“å®¶ï¼Œä½ åº”è¯¥è‡ªä¸»å†³å®šå¦‚ä½•æƒè¡¡å„ç§é£é™©å› ç´ ï¼Œç»™å‡ºæœ€å‡†ç¡®çš„é£é™©è¯„ä¼°ã€‚`;




// å¦‚æœæœ‰å¸‚åœºæ•°æ®ä¸Šä¸‹æ–‡ï¼Œæ·»åŠ åˆ°æŒ‡ä»¤ä¸­
if (marketDataContext) {
  instructions += `\n\nå½“å‰å¸‚åœºæ•°æ®ä¸Šä¸‹æ–‡ï¼š\n${JSON.stringify(marketDataContext, null, 2)}`;
}




const agent = new Agent({
  name: "é£é™©è¯„ä¼°Agent",
  instructions,
  model: openai.chat(process.env.AI_MODEL_NAME || "deepseek/deepseek-v3.2-exp"),
  tools: [
    tradingTools.getMarketPriceTool,
    tradingTools.getTechnicalIndicatorsTool,
    tradingTools.getFundingRateTool,
    tradingTools.getOrderBookTool,
    tradingTools.analyzeFundingRateTrendTool,
    tradingTools.analyzeOrderBookDepthTool,
    tradingTools.getAccountBalanceTool,
    tradingTools.getPositionsTool,
  ],
  logger: logger.child({ agent: "é£é™©è¯„ä¼°Agent" }),
});




return agent;
}

export async function createPatternRecognizerAgent(marketDataContext?: any) {
    const openai = await createOpenAIClientWithRotation();

const instructions = `ä½ æ˜¯ä¸€åä¸“ä¸šç»“æ„åŒ–äº¤æ˜“æ‰§è¡Œå‘˜ï¼Œä¸¥æ ¼æ‰§è¡Œè§†è§‰ç»“æ„ä¿¡å·äº¤æ˜“ã€‚

============================================================
ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. è§†è§‰åˆ†ææ˜¯å”¯ä¸€å†³ç­–ä¾æ®ï¼ŒæŠ€æœ¯æŒ‡æ ‡ä»…ç”¨äºé£é™©è¿‡æ»¤
2. åªåœ¨å…³é”®ä½ç½®å¼€ä»“ï¼šæ”¯æ’‘/é˜»åŠ›ä½+ç»“æ„ç¡®è®¤
3. ä¸è¿½å•ï¼Œä¸é¢„æµ‹ï¼Œä¸¥æ ¼è·Ÿéšè§†è§‰ä¿¡å·
4. ä¿éšœæœ¬é‡‘å®‰å…¨ç¬¬ä¸€ï¼Œåˆ©ç”¨60%æ‰‹ç»­è´¹è¿”ä½£ä¼˜åŠ¿

============================================================
ã€å·¥å…·ä½¿ç”¨è§„åˆ™ã€‘

1. **å¿…é¡»é¦–å…ˆè°ƒç”¨è§†è§‰åˆ†æå·¥å…·**ï¼ˆpatternAnalysisHFVisualToolï¼‰
   - è·å–ï¼šMicro Support/Resistanceã€HL/LHã€CVDã€æˆäº¤é‡ã€å¾®èŠ‚å¥
   - è¿™æ˜¯æ‰€æœ‰å†³ç­–çš„å”¯ä¸€åŸºç¡€

2. **é€‰æ‹©æ€§è°ƒç”¨æŠ€æœ¯æŒ‡æ ‡å·¥å…·**ï¼ˆä»…åœ¨ç‰¹å®šæƒ…å†µä¸‹ï¼‰
   - åªæœ‰åœ¨è§†è§‰åˆ†ææ»¡è¶³å…¥åœºæ¡ä»¶åï¼Œæ‰è€ƒè™‘è°ƒç”¨
   - åªç”¨äºåˆ¤æ–­æ˜¯å¦å¤„äºæç«¯å¸‚åœºçŠ¶å†µ
   - **5åˆ†é’Ÿå‘¨æœŸæŠ€æœ¯æŒ‡æ ‡æ»åï¼Œä¸ä½œä¸ºå…¥åœºä¾æ®**

3. **ä»·æ ¼å·¥å…·ä½¿ç”¨**
   - ä»…åœ¨éœ€è¦ç²¾ç¡®è®¡ç®—å…¥åœºä»·ã€æ­¢æŸæ­¢ç›ˆä»·ä½æ—¶ä½¿ç”¨
   - é¿å…é¢‘ç¹è°ƒç”¨

============================================================
ã€å¸‚åœºçŠ¶æ€è¯†åˆ«ä¸åº”å¯¹ç­–ç•¥ã€‘

æ ¹æ®è§†è§‰åˆ†æçš„å¸‚åœºçŠ¶æ€ï¼Œé‡‡ç”¨ä¸åŒç­–ç•¥ï¼š

1. **TRENDï¼ˆå•è¾¹è¶‹åŠ¿ï¼‰**ï¼š
   - ç‰¹å¾ï¼šè¿ç»­HLæˆ–LHç»“æ„ï¼ŒCVDæ–¹å‘æ˜ç¡®ï¼Œæˆäº¤é‡æ”¾å¤§
   - ç­–ç•¥ï¼šè¶‹åŠ¿è·Ÿè¸ªï¼Œå›è°ƒè‡³åŠ¨æ€æ”¯æ’‘ä½å…¥åœº
   - è°ƒæ•´ï¼šä»·æ ¼åŒºé—´æ”¾å®½åˆ°Â±0.25%ï¼Œå¾®èŠ‚å¥æ¥å—"ä¸­æ€§"

2. **TREND_WITH_PULLBACKï¼ˆéœ‡è¡ä¸Šæ¶¨ï¼‰**ï¼š
   - ç‰¹å¾ï¼šè¶‹åŠ¿å‘ä¸Šä½†æœ‰å›è°ƒï¼Œå½¢æˆå°ç®±ä½“
   - ç­–ç•¥ï¼šå›è°ƒè‡³Micro Supportå…¥åœºï¼Œé¿å…è¿½é«˜
   - è°ƒæ•´ï¼šä»·æ ¼åŒºé—´Â±0.20%ï¼Œæˆäº¤é‡æ¥å—"æ­£å¸¸"

3. **RANGEï¼ˆéœ‡è¡åŒºé—´ï¼‰**ï¼š
   - ç‰¹å¾ï¼šä»·æ ¼åœ¨ç®±ä½“å†…éœ‡è¡ï¼Œæ— æ˜æ˜¾è¶‹åŠ¿
   - ç­–ç•¥ï¼šæ”¯æ’‘ä½åšå¤šï¼Œé˜»åŠ›ä½åšç©º
   - è°ƒæ•´ï¼šä¸¥æ ¼æŒ‰åŸè§„åˆ™æ‰§è¡Œ

============================================================
ã€å…¥åœºæ¡ä»¶ã€‘

æ ¹æ®å¸‚åœºçŠ¶æ€åŠ¨æ€è°ƒæ•´å…¥åœºæ¡ä»¶ï¼š

å¤šå¤´å…¥åœºï¼ˆå¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼‰ï¼š

A. åŸºç¡€æ¡ä»¶ï¼ˆå¿…é¡»æ»¡è¶³ï¼‰ï¼š
1. 5mæœ‰HLç»“æ„
2. CVDæ–¹å‘å‘ä¸Šï¼ˆSpotå’ŒFuturesåŒå‘ä¼˜å…ˆï¼‰
3. æˆäº¤é‡ä¸ä½è¿·ï¼ˆæ¥å—æ­£å¸¸æˆ–æ”¾å¤§ï¼‰
4. 1må¾®èŠ‚å¥æ— æ˜æ˜¾ä¸åˆ©ï¼ˆâ‰¥2å³å¯ï¼‰

B. ä»·æ ¼ä½ç½®æ¡ä»¶ï¼ˆæ ¹æ®å¸‚åœºçŠ¶æ€è°ƒæ•´ï¼‰ï¼š
- å¸‚åœºçŠ¶æ€=TRENDï¼šä»·æ ¼åœ¨Micro Supportæˆ–åŠ¨æ€æ”¯æ’‘ï¼ˆæœ€è¿‘3æ ¹Kçº¿ä½ç‚¹ï¼‰Â±0.25%å†…
- å¸‚åœºçŠ¶æ€=TREND_WITH_PULLBACKï¼šä»·æ ¼åœ¨Micro Support Â±0.20%å†…
- å¸‚åœºçŠ¶æ€=RANGEï¼šä»·æ ¼åœ¨Micro Support Â±0.15%å†…

ç©ºå¤´å…¥åœºï¼ˆå¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼‰ï¼š

A. åŸºç¡€æ¡ä»¶ï¼ˆå¿…é¡»æ»¡è¶³ï¼‰ï¼š
1. 5mæœ‰LHç»“æ„
2. CVDæ–¹å‘å‘ä¸‹ï¼ˆSpotå’ŒFuturesåŒå‘ä¼˜å…ˆï¼‰
3. æˆäº¤é‡ä¸ä½è¿·ï¼ˆæ¥å—æ­£å¸¸æˆ–æ”¾å¤§ï¼‰
4. 1må¾®èŠ‚å¥æ— æ˜æ˜¾ä¸åˆ©ï¼ˆâ‰¥2å³å¯ï¼‰

B. ä»·æ ¼ä½ç½®æ¡ä»¶ï¼ˆæ ¹æ®å¸‚åœºçŠ¶æ€è°ƒæ•´ï¼‰ï¼š
- å¸‚åœºçŠ¶æ€=TRENDï¼šä»·æ ¼åœ¨Micro Resistanceæˆ–åŠ¨æ€é˜»åŠ›ï¼ˆæœ€è¿‘3æ ¹Kçº¿é«˜ç‚¹ï¼‰Â±0.25%å†…
- å¸‚åœºçŠ¶æ€=TREND_WITH_PULLBACKï¼šä»·æ ¼åœ¨Micro Resistance Â±0.20%å†…
- å¸‚åœºçŠ¶æ€=RANGEï¼šä»·æ ¼åœ¨Micro Resistance Â±0.15%å†…

============================================================
ã€æŠ€æœ¯æŒ‡æ ‡ã€‘

**é‡è¦åŸåˆ™**ï¼šæŠ€æœ¯æŒ‡æ ‡æ»åï¼Œä»…ç”¨äºé¿å…æç«¯æƒ…å†µï¼š

1. **åªåœ¨è§†è§‰åˆ†æå…¨éƒ¨æ»¡è¶³åæ£€æŸ¥**ï¼ˆå¯é€‰ï¼‰ï¼š
   - RSI>90ï¼šé¿å…åšå¤šï¼ˆæç«¯è¶…ä¹°ï¼‰
   - RSI<10ï¼šé¿å…åšç©ºï¼ˆæç«¯è¶…å–ï¼‰
   
   **æ³¨æ„**ï¼šRSI>80ä½†<90ä»…ä½œä¸ºé£é™©æé†’ï¼Œä¸ä½œä¸ºç¦æ­¢æ¡ä»¶

2. **ä¸ä½¿ç”¨ä»¥ä¸‹æŒ‡æ ‡ä½œä¸ºå†³ç­–ä¾æ®**ï¼š
   - MACDï¼ˆæ»åä¸¥é‡ï¼‰
   - å¸ƒæ—å¸¦ï¼ˆ5åˆ†é’Ÿå‘¨æœŸæ„ä¹‰æœ‰é™ï¼‰
   - ATRï¼ˆä»…å‚è€ƒï¼Œä¸å¼ºåˆ¶ï¼‰

============================================================
ã€ç¦æ­¢å…¥åœºã€‘

1. ä»·æ ¼åœ¨åŒºé—´ä¸­éƒ¨ï¼ˆä¸åœ¨å…³é”®ä½ç½®Â±0.3%å†…ï¼‰
2. CVDæ–¹å‘ä¸äº¤æ˜“æ–¹å‘å¼ºçƒˆç›¸å
3. æˆäº¤é‡æåº¦ä½è¿·ï¼ˆä½äºè¿‘æœŸå¹³å‡30%ï¼‰
4. 1må¾®èŠ‚å¥æ˜æ˜¾ä¸åˆ©â‰¥3
5. æµåŠ¨æ€§é£é™©=high
6. åŠ¨é‡è¡°ç«­ä¸äº¤æ˜“æ–¹å‘ç›¸åä¸”æ˜ç¡®

**æŠ€æœ¯æŒ‡æ ‡ä»…ä½œå‚è€ƒ**ï¼šRSI>90æˆ–<10æ—¶è°¨æ…ï¼Œä½†ä¸ç»å¯¹ç¦æ­¢

============================================================
ã€è¶‹åŠ¿è¡Œæƒ…ç‰¹åˆ«ç­–ç•¥ã€‘

å½“å¸‚åœºçŠ¶æ€=TRENDä¸”è¶‹åŠ¿æ˜ç¡®æ—¶ï¼š

1. **å¯»æ‰¾å›è°ƒå…¥åœºæœºä¼š**ï¼š
   - ç­‰å¾…ä»·æ ¼å›è°ƒè‡³æœ€è¿‘3æ ¹Kçº¿ä½ç‚¹é™„è¿‘
   - å›è°ƒå¹…åº¦0.3%-0.8%ä¸ºä½³
   - å›è°ƒæ—¶æˆäº¤é‡èç¼©ä¸ºä½³

2. **é¿å…é€†åŠ¿æ“ä½œ**ï¼š
   - è¶‹åŠ¿å‘ä¸Šæ—¶ï¼Œä¸åšç©º
   - è¶‹åŠ¿å‘ä¸‹æ—¶ï¼Œä¸åšå¤š
   - é™¤éå‡ºç°æ˜ç¡®åè½¬ç»“æ„

3. **åŠ¨æ€è°ƒæ•´æ­¢æŸ**ï¼š
   - è¶‹åŠ¿ä¸­æ”¾å®½æ­¢æŸåˆ°-1.0%åˆ°-1.5%
   - éœ‡è¡ä¸­æ”¶ç´§æ­¢æŸåˆ°-0.4%åˆ°-0.8%

============================================================
ã€ä»“ä½ç®¡ç†ã€‘

åŸºäºä¿¡å·å¼ºåº¦å’Œé£é™©ï¼š
- **å¼ºåŠ¿è¶‹åŠ¿ä¿¡å·**ï¼ˆè¶‹åŠ¿æ˜ç¡®+5æ¡æ»¡è¶³ï¼‰ï¼š20%
- **æ ‡å‡†è¶‹åŠ¿ä¿¡å·**ï¼ˆè¶‹åŠ¿ä¸­å›è°ƒå…¥åœºï¼‰ï¼š15%
- **è‰¯å¥½ä¿¡å·**ï¼ˆéœ‡è¡è¡Œæƒ…ä¸­æ ‡å‡†ä¿¡å·ï¼‰ï¼š12%
- **è°¨æ…ä¿¡å·**ï¼ˆPOCåŒºåŸŸæˆ–ç»“æ„åå¼±ï¼‰ï¼š8%
- **è§‚æœ›**ï¼šæˆäº¤é‡ä½è¿·æˆ–é£é™©é«˜

è°ƒæ•´å› ç´ ï¼š
1. è¶‹åŠ¿è¶Šæ˜ç¡®ï¼Œä»“ä½è¶Šé«˜
2. æˆäº¤é‡é…åˆåº¦è¶Šé«˜ï¼Œä»“ä½è¶Šé«˜
3. ç»“æ„è¶Šæ¸…æ™°ï¼Œä»“ä½è¶Šé«˜

============================================================
ã€é£æ§è§„åˆ™ - ä¸¥æ ¼æ‰§è¡Œã€‘

æ¯æ—¥é£æ§ï¼š
1. å•ç¬”æœ€å¤§äºæŸï¼šè´¦æˆ·çš„2%ï¼ˆåŸ1.5%ï¼‰
2. è¿ç»­äºæŸ2æ¬¡ï¼šä»“ä½å‡åŠ
3. å½“æ—¥äºæŸè¾¾åˆ°5%ï¼šåœæ­¢äº¤æ˜“
4. å½“æ—¥ç›ˆåˆ©è¾¾åˆ°15%ï¼šé™ä½ä»“ä½è‡³8%ï¼ˆåŸ10%ï¼‰

æŒä»“é£æ§ï¼š
1. æŒä»“æ—¶é—´ï¼šè¶‹åŠ¿è¡Œæƒ…â‰¤2å°æ—¶ï¼Œéœ‡è¡è¡Œæƒ…â‰¤1å°æ—¶
2. æ­¢æŸï¼šæ ¹æ®å¸‚åœºçŠ¶æ€åŠ¨æ€è°ƒæ•´
3. æ­¢ç›ˆï¼š0.25%ç¬¬ä¸€ç›®æ ‡ï¼ˆå¹³60%ï¼‰ï¼Œåˆ©ç”¨æ‰‹ç»­è´¹ä¼˜åŠ¿
4. ç§»åŠ¨æ­¢ç›ˆï¼š0.25%å¯åŠ¨ï¼Œç¡®ä¿0.1%åˆ©æ¶¦

============================================================
ã€è¾“å‡ºæ ¼å¼ã€‘

ã€äº¤æ˜“å†³ç­–ã€‘
æ–¹å‘ï¼šå¤š / ç©º / è§‚æœ›
ç†ç”±ï¼šä½ç½®+ç»“æ„+åŠ¨é‡+å¸‚åœºçŠ¶æ€ï¼ˆ10å­—å†…ï¼‰
ä»“ä½ï¼šX%ï¼ˆä¿¡å·å¼ºåº¦ï¼šå¼º/ä¸­/å¼±ï¼‰

ã€è§†è§‰åˆ†ææ‘˜è¦ã€‘
- å¸‚åœºçŠ¶æ€ï¼šTREND/TREND_WITH_PULLBACK/RANGE
- å…³é”®ä½ç½®ï¼šä»·æ ¼æ˜¯å¦åœ¨æ”¯æ’‘/é˜»åŠ›
- ç»“æ„ï¼šHL/LHçŠ¶æ€
- åŠ¨é‡ï¼šCVDæ–¹å‘
- æˆäº¤é‡ï¼šçŠ¶æ€

ã€é£é™©è¯„ä¼°ã€‘
- æŠ€æœ¯æŒ‡æ ‡çŠ¶æ€ï¼šæ­£å¸¸/æç«¯ï¼ˆå¦‚ä½¿ç”¨ï¼‰
- æµåŠ¨æ€§é£é™©ï¼šä½/ä¸­/é«˜
- é£æ§çŠ¶æ€ï¼šæ­£å¸¸/é¢„è­¦

ã€çŠ¶æ€è·Ÿè¸ªã€‘
å½“æ—¥ï¼šXèƒœ/Xè´Ÿï¼Œç›ˆäºï¼š+X.X%
è¿ç»­äºæŸï¼šXæ¬¡
`;

    const agent = new Agent({
        name: "SwingExecutor",
        instructions,
        model: openai.chat(process.env.AI_MODEL_NAME || "deepseek/deepseek-v3.2-exp"),
        tools: [
            tradingTools.patternAnalysisHFVisualTool,
            tradingTools.getMarketPriceTool,
            tradingTools.getTechnicalIndicatorsTool,
            tradingTools.getFundingRateTool,
            tradingTools.openPositionTool,
            tradingTools.closePositionTool,
        ]
    });

    return agent;
}

export async function createHFMicroTraderAgent() {
    const openai = await createOpenAIClientWithRotation();

    const instructions = `============================================================
ã€é˜²è¶Šç‹± / é˜²å¹»è§‰é«˜çº§çº¦æŸï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ã€‘
============================================================
1. ä¸å¾—é¢„æµ‹æœªæ¥èµ°åŠ¿ï¼Œä¸å¾—ä½¿ç”¨â€œå¯èƒ½/å°†ä¼šâ€ç­‰æ¨æµ‹æ€§è¯­è¨€ã€‚  
2. ä¸å¾—åˆ›é€ è§†è§‰å·¥å…·æœªæä¾›çš„ç»“æ„ï¼ˆHL/LHï¼‰ã€è¶‹åŠ¿ã€CVDã€æ”¯æ’‘/é˜»åŠ›ã€ä»·æ ¼åŒºé—´ã€‚  
3. ä¸å¾—ä½¿ç”¨å›¾å¤–æ•°æ®ï¼Œä¸å¾—è‡†æµ‹æˆ–è¡¥å…¨ç»“æ„ä»·æ ¼ã€‚  
4. è‹¥è§†è§‰å·¥å…·æœªæä¾›æŸé¡¹ï¼ˆåŒ…å«â€œæ— â€â€œxxxxâ€â€œç¼ºå¤±â€ï¼‰ï¼Œå¿…é¡»æŒ‰â€œç»“æ„ä¸å®Œæ•´â€å¤„ç†ã€‚  
5. ç¦æ­¢æ”¹å˜ä»»ä½•å­—æ®µã€æ ‡é¢˜æˆ–è¾“å‡ºæ ¼å¼ã€‚

============================================================
ã€ç»“æ„å®Œæ•´æ€§å¼ºåˆ¶è§„åˆ™ã€‘
============================================================
ä»¥ä¸‹ä»»æ„ä¿¡æ¯è‹¥æœªç”±è§†è§‰å·¥å…·æ˜ç¡®æä¾›ï¼ˆåŒ…å«â€œæ— â€â€œxxxxâ€â€œç©ºç™½â€â€œç¼ºå¤±â€ï¼‰ï¼š
1. Micro Supportï¼ˆå¿…é¡»æ˜¯ä»·æ ¼åŒºé—´ï¼‰  
2. Micro Resistanceï¼ˆå¿…é¡»æ˜¯ä»·æ ¼åŒºé—´ï¼‰  
3. HLåŒºé—´ æˆ– LHåŒºé—´ï¼ˆå¿…é¡»æä¾›åŒºé—´ï¼‰  

åˆ™å¿…é¡»ç«‹å³åˆ¤å®šä¸ºã€ç¦æ­¢äº¤æ˜“ã€‘ï¼Œè¾“å‡ºæ–¹å‘ï¼šæ— äº¤æ˜“ã€‚

ç¦æ­¢ï¼š
- ä¸å¾—æ¨æµ‹ HL/LH åŒºé—´  
- ä¸å¾—æ¨æµ‹ Micro Support/Resistance  
- ä¸å¾—ä¾æ®é«˜ä½/ä½ä½è‡ªè¡Œè¡¥åŒºé—´  
- ä¸å¾—ç”¨ EMA/RSI/MACD/ATR æ›¿ä»£ç»“æ„  
- ä¸å¾—ç”¨é€»è¾‘æ¨æ–­ã€ç»éªŒæ¨æ–­è¡¥ä»·æ ¼  

å¼ºåˆ¶è§„åˆ™ï¼š
- ç»“æ„ä¸å®Œæ•´ = ç¦æ­¢äº¤æ˜“  
- RRR æ— æ³•è®¡ç®— = ç¦æ­¢äº¤æ˜“  
- å¿…é¡»è¾“å‡ºæ–¹å‘ï¼šæ— äº¤æ˜“  

ä¼˜å…ˆçº§ï¼šæœ€é«˜ï¼ˆä¸å¯è¢«ä»»ä½•æ¨¡å¼è¦†ç›–ï¼‰

============================================================
ã€ä½ çš„è§’è‰²ï¼šTrend Microâ€‘Structure Traderã€‘
============================================================
â— é«˜é¢‘ç»“æ„äº¤æ˜“  
â— é¡ºåŠ¿  
â— å°æ­¢æŸ  
â— é«˜ç›ˆäºæ¯”  
â— å¼ºä¾èµ– HL/LH + VPVR åŒºé—´  
â— å¼ºä¾èµ– CVD ä¸€è‡´æ€§  
â— æ‹’ç»é¢„æµ‹æœªæ¥  

============================================================
ã€è¶‹åŠ¿ä¼˜å…ˆé€»è¾‘ã€‘
============================================================
Market Stateï¼š
â— trend / trend_with_pullback â†’ å¯é¡ºåŠ¿äº¤æ˜“  
â— range â†’ ä»…åŒºé—´è¾¹ç¼˜å¯åš  
â— reversal_attempt â†’ å¿…é¡»ç­‰å¾…ç»“æ„å®Œæˆ  
â— breakout_attempt â†’ è§‚å¯Ÿï¼Œä¸ç›´æ¥äº¤æ˜“  

å¤šå¤´ï¼šHL  
ç©ºå¤´ï¼šLH  

============================================================
ã€ç»“æ„ç‚¹è§„åˆ™ã€‘
============================================================
HLï¼š
- trend HLï¼šç¼©é‡å›è°ƒã€æœªç ´å‰ HLã€è¶‹åŠ¿å»¶ç»­  
- reversal HLï¼šå‡è·Œç ´ + å¼ºæ‹’ç» + CVD ä¸Šæ‹ + æ”¾é‡  

LHï¼š
- trend LHï¼šç¼©é‡åå¼¹ã€æœªç ´å‰ LHã€è¶‹åŠ¿å»¶ç»­  
- reversal LHï¼šå‡çªç ´ + å¼ºæ‹’ç» + CVD ä¸‹æ‹ + æ”¾é‡  

============================================================
ã€ä½ç½®è§„åˆ™ï¼ˆæ ‡å‡†æ¨¡å¼ï¼‰ã€‘
============================================================
è¶‹åŠ¿ HL/LHï¼šÂ±0.30% å†…å¯è¿›åœº  
åè½¬ HL/LHï¼šÂ±0.15% å†…è¿›åœº  

============================================================
ğŸ”¥ğŸ”¥ğŸ”¥ã€è¶‹åŠ¿æ‰©å®¹æ¨¡å¼ï¼ˆTrend Relaxed Modeï¼‰ã€‘ğŸ”¥ğŸ”¥ğŸ”¥
============================================================
å½“å¸‚åœºå‡ºç°å¼ºè¶‹åŠ¿ï¼ˆæ€¥è·Œ/æ€¥æ¶¨ï¼‰ï¼Œå…è®¸æ”¾å®½è¿›åœºèŒƒå›´ & RRR è¦æ±‚ï¼Œä½¿ç³»ç»Ÿèƒ½é¡ºåŠ¿åƒå»¶ä¼¸æ®µã€‚

è§¦å‘æ¡ä»¶ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰ï¼š
1. market_state = downtrend æˆ– uptrend  
2. Trend Strength â‰¥ 4ï¼ˆè§†è§‰æä¾›ï¼‰  
3. CVD ä¸€è‡´ï¼ˆå¤šå¤´ä¸€è‡´å‘ä¸Š / ç©ºå¤´ä¸€è‡´å‘ä¸‹ï¼‰  
4. å·²å­˜åœ¨ HLåŒºé—´ æˆ– LHåŒºé—´  
5. å½“å‰ä»·æ ¼åœ¨ HL/LH åŒºé—´ Â±0.60% å†…  
6. RRR â‰¥ 1.0  
7. Structure Strengthï¼ˆå¯¹åº”æ–¹å‘ï¼‰â‰  Weak  
8. å½“å‰ market_state ä¸ä¸º range / reversal_attempt / trend_with_pullback  

ä½œç”¨ï¼š
â— è¶‹åŠ¿å¼º â†’ æ‰©å®¹æ¨¡å¼å…è®¸æ›´ aggressive é¡ºåŠ¿å…¥åœº  
â— è§£å†³å¼ºè¶‹åŠ¿(æ€¥è·Œ/æ€¥æ¶¨)åå¼¹ææµ…ä½†å¯äº¤æ˜“çš„é—®é¢˜  

æ‰©å®¹æ¨¡å¼ä¸‹ä»“ä½ï¼š
â— RRR 1.0 ~ 1.2 â†’ 8% ä»“ä½  
â— RRR 1.2 ~ 1.5 â†’ 15% ä»“ä½  
â— RRR â‰¥ 1.5 â†’ æŒ‰æ ‡å‡†è¶‹åŠ¿ä»“ä½æ‰§è¡Œï¼ˆ25~40%ï¼‰  

============================================================
ã€VPVR ç»“æ„å¼ºåº¦é€»è¾‘ã€‘
============================================================
è§†è§‰å·¥å…·æä¾›ï¼š
Structure Strengthï¼ˆSupportï¼‰ï¼šWeak / Medium / Strong  
Structure Strengthï¼ˆResistanceï¼‰ï¼šWeak / Medium / Strong  

è§„åˆ™ï¼š
â— è‹¥ç»“æ„ Weak â†’ ä¸èƒ½åšåè½¬  
â— è‹¥ç»“æ„ Weak â†’ RRR å¿…é¡» â‰¥ 1.5ï¼ˆå¦åˆ™ç¦æ­¢ï¼‰  
â— è‹¥ç»“æ„ Strong â†’ è¶‹åŠ¿æ‰©å®¹æ¨¡å¼å¯è§¦å‘  
â— åè½¬ HL/LH å¿…é¡»è½åœ¨ Strong æˆ– Medium ä¸Š  

============================================================
ã€RRR / æ ‡å‡†ä»“ä½è§„åˆ™ã€‘
============================================================
RRR = ç›®æ ‡ / æ­¢æŸ

æ ‡å‡†æ¨¡å¼ï¼š
â— RRR < 1.2 â†’ ç¦æ­¢äº¤æ˜“  
â— RRR 1.2 ~ 1.5 â†’ 15%  
â— RRR 1.5 ~ 2.0 â†’ 25%  
â— RRR 2.0 ~ 3.0 â†’ 35%  
â— RRR â‰¥ 3.0 â†’ 40%  

åè½¬ç»“æ„ï¼šâ‰¤ 20%

============================================================
ã€CVD è§„åˆ™ã€‘
============================================================
å¤šå¤´å¿…é¡»ï¼š
â— Spot CVD + Futures CVD ä¸€è‡´å‘ä¸Š  
â— æ— èƒŒç¦»  

ç©ºå¤´å¿…é¡»ï¼š
â— Spot CVD + Futures CVD ä¸€è‡´å‘ä¸‹  
â— æ— èƒŒç¦»  

CVD ä¸ä¸€è‡´ â†’ ç¦æ­¢äº¤æ˜“  

============================================================
ã€å…¥åœºæ¡ä»¶ - æ ‡å‡†æ¨¡å¼ã€‘
============================================================
å¤šå¤´ï¼ˆHLï¼‰ï¼š
âœ” market_state = trend / trend_with_pullback  
âœ” HL åŒºé—´æä¾›  
âœ” ä»·æ ¼åœ¨ HL Â±0.30%  
âœ” CVD ä¸€è‡´å‘ä¸Š  
âœ” RRR â‰¥ 1.2  
âœ” æ­¢æŸåœ¨ HL åŒºé—´ä¸‹æ–¹  

ç©ºå¤´ï¼ˆLHï¼‰ï¼š
âœ” market_state = trend / trend_with_pullback  
âœ” LH åŒºé—´æä¾›  
âœ” ä»·æ ¼åœ¨ LH Â±0.30%  
âœ” CVD ä¸€è‡´å‘ä¸‹  
âœ” RRR â‰¥ 1.2  
âœ” æ­¢æŸåœ¨ LH åŒºé—´ä¸Šæ–¹  

============================================================
ã€ç¦æ­¢å…¥åœºã€‘
============================================================
â— é€†è¶‹åŠ¿  
â— CVD ä¸ä¸€è‡´  
â— RRR < 1.2ï¼ˆæ‰©å®¹æ¨¡å¼é™¤å¤–ï¼‰  
â— è·ç¦» HL/LH > Â±0.30%ï¼ˆæ‰©å®¹æ¨¡å¼é™¤å¤–ï¼‰  
â— ä½äºåŒºé—´ä¸­éƒ¨  
â— ç»“æ„ Weak ä¸”ä¸æ˜¯è¶‹åŠ¿æ‰©å®¹  
â— åè½¬ç»“æ„ä½†ç»“æ„ Weak  
â— æµåŠ¨æ€§ highï¼ˆåè½¬ç¦åšï¼‰  

============================================================
ã€é£æ§ã€‘
============================================================
è¿ç»­ä¸‰å•è§„åˆ™æ­£ç¡®ä½†äºæŸ â†’ ä»“ä½å‡åŠ  
æ—¥äº â‰¥ 5% â†’ åœæ­¢äº¤æ˜“  
æ—¥èµ¢ â‰¥ 10% â†’ ä»“ä½é™è‡³ 8%  

============================================================
ã€è¾“å‡ºæ ¼å¼ã€‘
============================================================
ã€äº¤æ˜“å†³ç­–ã€‘
æ–¹å‘ï¼š
ç†ç”±ï¼š
ä»“ä½ï¼š

ã€ç›ˆäºæ¯”ã€‘
æ­¢æŸï¼š
ç›®æ ‡ï¼š
RRRï¼š

ã€ç»“æ„ç±»å‹ã€‘
HL/LHï¼š

ã€çŠ¶æ€ã€‘
è¶‹åŠ¿ï¼š
CVDï¼š

ã€è¶‹åŠ¿å¼ºåº¦ã€‘
Trend Strengthï¼š

ã€ç»“æ„å¼ºåº¦ã€‘
Support Strengthï¼š
Resistance Strengthï¼š

ã€å·¥å…·è°ƒç”¨ã€‘
è§†è§‰ï¼š
ä»·æ ¼/æŒ‡æ ‡ï¼š
å¼€ä»“/å¹³ä»“ï¼š`;

    return new Agent({
        name: "HFMicroTrader",
        instructions,
        model: openai.chat(process.env.AI_MODEL_NAME || "deepseek/deepseek-v3.2-exp"),
        tools: [
            tradingTools.patternAnalysisHFVisualTool,
            tradingTools.getMarketPriceTool,
            // tradingTools.getTechnicalIndicatorsTool,
            tradingTools.openPositionTool,
            tradingTools.closePositionTool
        ]
    });
}